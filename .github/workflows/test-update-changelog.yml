name: Update Changelog File (Test)

permissions:
    contents: write

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    update:
        runs-on: ubuntu-latest
        permissions:
            contents: write   
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                ref: main
                fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '20'

            - name: Get previous release tag
              id: previous_tag
              run: |
                # Garante que o ambiente tenha todas as tags para comparação
                git fetch --tags --force
                
                CURRENT_TAG="${{ github.event.release.tag_name }}"
                if [ -z "$CURRENT_TAG" ]; then CURRENT_TAG="${{ github.ref_name }}"; fi

                # Busca a tag anterior por data de criação (independente do nome)
                PREVIOUS_TAG=$(git tag --sort=-creatordate | grep -vx "${CURRENT_TAG}" | head -n 1)
                
                echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
                echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
                echo "::notice ::Current: $CURRENT_TAG | Previous: $PREVIOUS_TAG"

            - name: Get commits between releases
              id: commits
              run: |
                CURRENT_TAG="${{ steps.previous_tag.outputs.current_tag }}"
                PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
                
                if [ -z "$PREVIOUS_TAG" ]; then
                    COMMITS=$(git log "$CURRENT_TAG" --pretty=format:"%h|%s" --no-merges -n 50)
                else
                    COMMITS=$(git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%h|%s" --no-merges)
                fi
                
                echo "$COMMITS" > /tmp/commits.txt

            - name: Parse commits and generate changelog entry
              id: generate_entry
              run: |
                cat > /tmp/parse_commits.js << 'EOF'
                const fs = require('fs');
                const commits = fs.readFileSync('/tmp/commits.txt', 'utf8').split('\n').filter(Boolean);
                
                const categories = {
                    feat: 'Features',
                    fix: 'Bug Fixes',
                    perf: 'Performance Improvements',
                    docs: 'Documentation',
                    chore: 'Maintenance'
                };
                
                const groups = { 'Features': [], 'Bug Fixes': [], 'Performance Improvements': [], 'Documentation': [], 'Maintenance': [] };

                commits.forEach(line => {
                    const [hash, ...parts] = line.split('|');
                    const msg = parts.join('|').trim();
                    
                    // Regex ultra-flexível: aceita "tipo: mensagem" ou "tipo(escopo): mensagem"
                    const match = msg.match(/^(\w+)(?:\((.*?)\))?(!?):(.*)/i);
                    
                    if (match) {
                        const type = match[1].toLowerCase();
                        const scope = match[2];
                        const subject = match[4].replace(/#\d+/g, '').trim();
                        const prMatch = msg.match(/#(\d+)/);
                        const pr = prMatch ? ` ([#${prMatch[1]}](https://github.com/${process.env.REPO}/issues/${prMatch[1]}))` : '';
                        
                        const entry = `* ${scope ? `**${scope}:** ` : ''}${subject}${pr} ([${hash.substring(0,7)}](https://github.com/${process.env.REPO}/commit/${hash}))`;
                        
                        const cat = categories[type] || 'Maintenance';
                        if (groups[cat]) groups[cat].push(entry);
                    }
                });
                
                let content = '';
                ['Features', 'Bug Fixes', 'Performance Improvements', 'Documentation', 'Maintenance'].forEach(title => {
                    if (groups[title].length > 0) content += `\n### ${title}\n\n${groups[title].join('\n')}\n`;
                });
                fs.writeFileSync('/tmp/changelog_entry.txt', content);
                EOF
                
                REPO="${{ github.repository }}" node /tmp/parse_commits.js

            - name: Update CHANGELOG.md
              run: |
                CURRENT_TAG="${{ steps.previous_tag.outputs.current_tag }}"
                PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
                VERSION=$(echo "$CURRENT_TAG" | sed -E 's/.*\/v?|v//')
                DATE=$(date +%Y-%m-%d)
                REPO_URL="https://github.com/${{ github.repository }}"
                
                # Prepara o cabeçalho da nova versão
                if [ -n "$PREVIOUS_TAG" ]; then
                    HEADER="## [$VERSION]($REPO_URL/compare/$PREVIOUS_TAG...$CURRENT_TAG) ($DATE)"
                else
                    HEADER="## $VERSION ($DATE)"
                fi

                # Lógica de atualização segura sem usar SED
                {
                    echo "$HEADER"
                    cat /tmp/changelog_entry.txt
                    echo ""
                } > /tmp/new_block.txt

                if [ -f CHANGELOG.md ]; then
                    # Divide o arquivo em dois na linha do "All notable changes" e insere o novo bloco no meio
                    csplit CHANGELOG.md "/All notable changes/+1" --quiet --prefix="/tmp/changelog_part"
                    cat /tmp/changelog_part00 /tmp/new_block.txt /tmp/changelog_part01 > CHANGELOG.md
                else
                    echo -e "# Changelog\n\nAll notable changes to this project will be documented in this file.\n" > CHANGELOG.md
                    cat /tmp/new_block.txt >> CHANGELOG.md
                fi

            - name: Commit Change
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                commit_message: "docs: update changelog for ${{ steps.previous_tag.outputs.current_tag }} [skip ci]"
                file_pattern: CHANGELOG.md
