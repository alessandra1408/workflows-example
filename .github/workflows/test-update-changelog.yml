name: Update Changelog File (Test)

permissions:
    contents: write

on:
    release:
        types: [published]
    workflow_dispatch:

jobs:
    update:
        runs-on: ubuntu-latest
        permissions:
            contents: write   
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                ref: main
                fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '20'

            - name: Get previous release tag
              id: previous_tag
              run: |
                CURRENT_TAG="${{ github.event.release.tag_name }}"
                PREVIOUS_TAG=$(git tag --sort=-version:refname | grep "^v" | grep -A1 "$CURRENT_TAG" | tail -1)
                echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
                echo "Previous tag: $PREVIOUS_TAG"

            - name: Get commits between releases
              id: commits
              run: |
                CURRENT_TAG="${{ github.event.release.tag_name }}"
                PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
                
                if [ -z "$PREVIOUS_TAG" ]; then
                    echo "No previous tag found, using all commits"
                    COMMITS=$(git log "$CURRENT_TAG" --pretty=format:"%h|%s" --no-merges)
                else
                    COMMITS=$(git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"%h|%s" --no-merges)
                fi
                
                echo "$COMMITS" > /tmp/commits.txt
                cat /tmp/commits.txt

            - name: Parse commits and generate changelog entry
              id: generate_entry
              run: |
                REPO_OWNER="${{ github.repository_owner }}"
                REPO_NAME="${{ github.event.repository.name }}"
                
                cat > /tmp/parse_commits.js << 'EOF'
                const fs = require('fs');
                const commits = fs.readFileSync('/tmp/commits.txt', 'utf8').split('\n').filter(Boolean);
                
                const repoOwner = process.env.REPO_OWNER;
                const repoName = process.env.REPO_NAME;
                
                const features = [];
                const fixes = [];
                
                commits.forEach(line => {
                    const [hash, ...messageParts] = line.split('|');
                    const message = messageParts.join('|');
                    
                    const prMatch = message.match(/\(#(\d+)\)/);
                    const prNumber = prMatch ? prMatch[1] : null;
                    
                    let cleanMessage = message.replace(/\(#\d+\)/, '').trim();
                    
                    if (message.match(/^feat(\(.*?\))?:/i)) {
                        cleanMessage = cleanMessage.replace(/^feat(\(.*?\))?:\s*/i, '');
                        const scope = message.match(/^feat\((.*?)\):/i)?.[1];
                        const entry = scope 
                            ? `* **${scope}:** ${cleanMessage}${prNumber ? ` ([#${prNumber}](https://github.com/${repoOwner}/${repoName}/issues/${prNumber}))` : ''} ([${hash}](https://github.com/${repoOwner}/${repoName}/commit/${hash}))`
                            : `* ${cleanMessage}${prNumber ? ` ([#${prNumber}](https://github.com/${repoOwner}/${repoName}/issues/${prNumber}))` : ''} ([${hash}](https://github.com/${repoOwner}/${repoName}/commit/${hash}))`;
                        features.push(entry);
                    } else if (message.match(/^fix(\(.*?\))?:/i)) {
                        cleanMessage = cleanMessage.replace(/^fix(\(.*?\))?:\s*/i, '');
                        const scope = message.match(/^fix\((.*?)\):/i)?.[1];
                        const entry = scope
                            ? `* **${scope}:** ${cleanMessage}${prNumber ? ` ([#${prNumber}](https://github.com/${repoOwner}/${repoName}/issues/${prNumber}))` : ''} ([${hash}](https://github.com/${repoOwner}/${repoName}/commit/${hash}))`
                            : `* ${cleanMessage}${prNumber ? ` ([#${prNumber}](https://github.com/${repoOwner}/${repoName}/issues/${prNumber}))` : ''} ([${hash}](https://github.com/${repoOwner}/${repoName}/commit/${hash}))`;
                        fixes.push(entry);
                    }
                });
                
                let changelog = '';
                if (features.length > 0) {
                    changelog += '\n### Features\n\n' + features.join('\n') + '\n';
                }
                if (fixes.length > 0) {
                    changelog += '\n### Bug Fixes\n\n' + fixes.join('\n') + '\n';
                }
                
                fs.writeFileSync('/tmp/changelog_entry.txt', changelog);
                EOF
                
                REPO_OWNER="$REPO_OWNER" REPO_NAME="$REPO_NAME" node /tmp/parse_commits.js
                cat /tmp/changelog_entry.txt

            - name: Update CHANGELOG.md
              run: |
                CURRENT_TAG="${{ github.event.release.tag_name }}"
                PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
                VERSION="${CURRENT_TAG#v}"
                DATE=$(date -u +%Y-%m-%d)
                REPO_OWNER="${{ github.repository_owner }}"
                REPO_NAME="${{ github.event.repository.name }}"
                
                CHANGELOG_ENTRY=$(cat /tmp/changelog_entry.txt)
                
                if [ -z "$PREVIOUS_TAG" ]; then
                    NEW_ENTRY="## ${VERSION} (${DATE})${CHANGELOG_ENTRY}"
                else
                    NEW_ENTRY="## [${VERSION}](https://github.com/${REPO_OWNER}/${REPO_NAME}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}) (${DATE})${CHANGELOG_ENTRY}"
                fi
                
                if [ -f CHANGELOG.md ]; then
                    awk -v new_entry="$NEW_ENTRY" '
                        /^# Changelog/ {
                            print;
                            getline;
                            print;
                            getline;
                            if ($0 ~ /^All notable changes/) {
                                print;
                                print "";
                                print new_entry;
                                print "";
                            } else {
                                print "";
                                print new_entry;
                                print "";
                                print;
                            }
                            next;
                        }
                        { print }
                    ' CHANGELOG.md > CHANGELOG.md.new
                    mv CHANGELOG.md.new CHANGELOG.md
                else
                    echo "# Changelog" > CHANGELOG.md
                    echo "" >> CHANGELOG.md
                    echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
                    echo "" >> CHANGELOG.md
                    echo "$NEW_ENTRY" >> CHANGELOG.md
                fi

            - name: Commit Change
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                commit_message: "docs: update changelog for ${{ github.event.release.tag_name }} [skip ci]"
                file_pattern: CHANGELOG.md
                commit_user_name: github-actions[bot]
                commit_user_email: github-actions[bot]@users.noreply.github.com
