# Arquivo: .github/workflows/rollback.yml
name: Rollback Kong Staging Configuration

permissions:
  contents: write
  pull-requests: write
  actions: read

on:
  workflow_call:
    inputs:
      files_to_apply:
        type: string
        required: true
      stable_commit_sha:
        type: string
        required: false
        default: ''
      pr_number_to_revert:
        type: string
        required: true
      environment:
        type: string
        required: true
      region:
        type: string
        description: "Region"
        required: true
      region-name:
        type: string
        description: "The name of region"
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(inputs.files_to_apply) }}
        region: ${{ fromJson(inputs.region) }}
        region-name: ${{ fromJson(inputs.region-name) }}
    steps:
      - name: Checkout Code at Correct Version
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.stable_commit_sha }}

      - uses: kong/setup-deck@v1
        with:
          deck-version: 1.47.1

      - name: validate 
        run: |
          echo "job finished"
          echo "region: ${{ inputs.region }}"
          echo "region-name: ${{ inputs.region-name }}"

  create-revert-pr-manual:
    runs-on: ubuntu-latest
    needs: [rollback]
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: 'Checkout da branch principal'
        uses: actions/checkout@v4
        with:
          # Recomendo usar o token automático do GitHub e definir as permissões acima
          token: ${{ secrets.GITHUB_TOKEN }} 
          ref: 'main'

      - name: 'Configurar Git'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: 'Executar Revert PARCIAL e Criar PR'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ inputs.pr_number_to_revert }}
          MERGE_COMMIT_SHA=$(gh pr view $PR_NUMBER --json mergeCommit --jq '.mergeCommit.oid')
          
          if [ -z "$MERGE_COMMIT_SHA" ] || [ "$MERGE_COMMIT_SHA" == "null" ]; then
            echo "::error::Não foi possível encontrar o commit de merge para o PR #${PR_NUMBER}."
            exit 1
          fi
          
          NEW_BRANCH="revert-partial-${PR_NUMBER}-$(date +%s)"
          git checkout -b $NEW_BRANCH
          
          # --- Lógica do Revert Parcial ---
          # 1. Aplica o reverte na memória, mas não cria o commit
          git revert -m 1 --no-commit $MERGE_COMMIT_SHA
          
          # 2. Tira tudo da área de stage (index)
          git reset
          
          # 3. Adiciona de volta APENAS as alterações dentro da pasta 'services/'
          git add 'services/'
          
          # 4. Descarta todas as outras alterações indesejadas do revert
          git checkout -- .
          
          # 5. Agora, finalmente, cria o commit com o revert parcial
          git commit -m "Revert (services/): Rollback parcial do PR #${PR_NUMBER}"
          
          # --- Fim da Lógica ---
          
          # Enviar a nova branch para o repositório
          git push origin $NEW_BRANCH
          
          # Criar o Pull Request
          gh pr create \
            --base main \
            --head $NEW_BRANCH \
            --title "Revert (services/): Rollback parcial do PR #${PR_NUMBER}" \
            --body "Este PR reverte APENAS as alterações na pasta \`services/\` introduzidas no PR #${PR_NUMBER}."